<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>   
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script src="./app.js"></script>
	<title>Vizualizacija podataka</title>
</head>
<body>	
	<div class="row">	
		<div class="col-6">
			<div id="main" style="z-index: 0; position:absolute"></div>		
			<div  id="show" style="z-index: 5; position:absolute"></div>
		</div>	
		<div class="col-5" >			
				<h3 class="text-center mt-4">Å½upanija</h3>
				<div id="graph" class="text-center"></div>
							
		</div>
	</div>
	<div class="modal fade  bd-example-modal-lg" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
			  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			  </button>
			</div>
			<div class="modal-body">
			  <div id="detailGraph"></div>
			</div>
			<div class="modal-footer">			  
			</div>
		  </div>
		</div>
	  </div>	
    
    <script> 	
		var clicked;	
		var width = 960;
		var height = 700;
		var allData = [];
		var avg = new Uint32Array(23);
		var projection = d3.geo.mercator()
 			.center([0, 10])
 			.scale(6000)
			.translate([17600, 4500])
 			.rotate([-180, 0]);
		var path = d3.geo.path()
 			.projection(projection);
		//kontenjer svg
		var svg = d3.select("#main").append("svg")			
 			.attr("width", width)
 			.attr("height", height)
 			.style("background", "white")
 			.call(d3.behavior.zoom().on("zoom", function () {
   				 svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
 			}))
  			.append("g");	

 		d3.json("cro_regv3.json", function(error, cro) {
			 var data = topojson.feature(cro, cro.objects.layer1);
			 allData= data.features;			 
			calculateAvgs(data.features)
 			var states = svg.selectAll("path.county")
 			.data(data.features)
			 .enter()
			 .append("g")			 
			 .append("path")
			 
 			.on("mouseover", function(d){
				var path = d3.select("#"+d.id);
				d3.select("#show").html(d.properties.name)				
				.style("display", "inline-block")
				path.attr("fill", "#0c6091")
												
			})				
			.on("mouseleave",function(d,i){
				d3.select("#show")				
				.style("display", "none")
				var path = d3.select("#"+d.id);
				if(d.id !== clicked)		
					path.attr("fill", "#42b3f5") 	
			})
			.on("click",function(d){
				var path = d3.select("#"+d.id);
				var data = d.properties;
				removeGraph();
				setTimeout(() => { drawGraph(data)  }, 300);								
				
			})
			.attr("class", "county")					 
 			.attr("id", function(d) { return d.id; })
 			.attr("d", path)
 			.attr("fill", "#42b3f5") 			
			.style("stroke-width", 1)
			.style("stroke", "black")
 			.style("stroke-opacity", 1);	
		});
    
        document.onmousemove = function(e) { 
            var x = e.clientX; 
            var y = e.clientY; 
            document.getElementById('show').style.marginLeft = (x+50)+"px";
            document.getElementById('show').style.marginTop = (y-25)+"px";				
		}

		function drawDetailGraph(year){
			var height = 400;
			var width = 750;
		
			var svg = d3.select("#detailGraph")
				.append("svg")			
				.attr("width", width)
				.attr("height", height)
				.attr("class", "svgGraph")
				.style("background", "white")
			console.log(allData)

			var barchart = svg.selectAll("rect")			
				.data(allData)
				.enter()
				.append("rect")	
				.attr("x", function(d, i) { return 33 * i; })				
				
				.attr("width", 25)
				.attr("y", function(d,i) {
					var value= (d.properties.BDP[year+1996+"."]).replace(",","");
					return height - value*0.055656; 
				 })
				.attr("height", function(d,i) { 
					var value= (d.properties.BDP[year+1996+"."]).replace(",","");
					return value*0.08; 
				})
				
				.attr("fill", "#87e09f")				

		}

		function calculateAvgs(data){			
			data.forEach(zu=>{
				var bdp = (zu.properties.BDP)
				var res = getDataFromObject(bdp)
				var values = res[1][0]			
				for(var i=0;i<23;i++){										
					avg[i] += values[i]/21
				}								
			})						
		}

		function drawGraph(data){
			var width = 759;
			var height = 400;
			
			var res = getDataFromObject(data.BDP)	
			var values = res[1][0]
			var years = res[0][0]	
					

			var svg = d3.select("#graph")
				.append("svg")
				.attr("class", "svgGraph")
				.attr("width", width)
				.attr("height", height);

			var barchart = svg.selectAll("rect")
				.data(values)
				.enter()
				.append("rect")				
				.attr("class", "bar")
				.attr("data-toggle", "modal")
				.attr("data-target","#exampleModalCenter")
				.attr("x", function(d, i) { return 33 * i; })				
				.attr("y", height)
				.attr("width", 25)
				.attr("height",0)
				.attr("fill", "#87e09f")
				.on("mouseover", function(d,i){																
					d3.select("#show").html("BDP:"+d+"<br>Avg:"+avg[i])
					.style("border", "1px solid black")		
					.style("display", "inline-block")													
				})
				.on("mouseleave",function(d,i){
					d3.select("#show")				
					.style("display", "none")						
				})
				.on("click",function(d,i){
					drawDetailGraph(i)						
				})

				svg.selectAll("rect")
					.transition()
					.duration(200)
					.attr("y", function(d,i) { return height - d*0.055656 ; })
					.attr("height", function(d,i) { return d*0.08; })									
					.delay(0)

				svg.selectAll("p")
					.data(avg)
					.enter()
					.append("rect")
					.attr("class", "avg")
					.attr("x", function(d, i) { return 33 * i; })			
					.attr("width", 25)
					.attr("y", function(d,i) { return height ; })
					.attr("height", 1)					
					.attr("fill", "none")					
				
				svg.selectAll(".avg")
					.transition()
					.duration(300)
					.attr("y", function(d,i) { return height - d*0.055656 ; })
					.attr("fill", "black")	
					.delay(500)
				setTimeout(() => { $("h3").html(data.name)  }, 400);
				
				
		}
		
		function removeGraph(){
			var svg = d3.select("#graph")
			var barchart = svg.selectAll("rect")
			var numBars = (barchart[0].length)
			for(var i=0;i<numBars;i++){
				barchart[0][i].setAttribute("y","700px")	
			}
			setTimeout(() => { $("#graph").children().remove()}, 300);
					
		}

		function getDataFromObject(bdpObject){
			var bdpNumbers =[]
			var years= []
			Object.keys(bdpObject).map(function (key) {  
				years.push(Number(key.replace('.','')));   
				var numStr = (bdpObject[key]).replace(',','')
				 bdpNumbers.push([Number(numStr)]); 
				 
			}); 			
			bdpNumbers = [].concat.apply([],bdpNumbers)
			return [[years],[bdpNumbers]];
		}		
	</script>

</body>
</html>

<style>
.county:hover{
	cursor: pointer
}
.bar:hover{
	fill: #64b579;
	cursor: pointer;
}

#graph{
	height: 422px;
	padding: 10px;
	margin-right: auto;
	margin-left: auto;  
	border: 1px solid black;
	border-radius: 10px;
}
#show{	
	display: none;
	background-color: white;	
	padding: 5px;
	border: 1px solid black;
	border-radius: 5px;
}

rect{
	transition: y 0.3s ease-in 0s ;	
}
.avg{
	transition: fill 0.2s ease-in 0.3s;
}

h3 {     
    margin-right: auto;
    margin-left: auto;       
}



</style>